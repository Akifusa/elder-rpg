<!doctype html>
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Elder RPG (prototype)</title>
<style>
  html,body{margin:0;height:100%}
  #c{width:100vw;height:100vh;display:block;background:#0a0f25}
  #ui{position:fixed;left:8px;top:8px;z-index:10}
  button{padding:.4rem .6rem;border:0;border-radius:.5rem}
</style>
<canvas id="c"></canvas>
<div id="ui">
  <button id="avatarBtn">👤 アバター切替</button>
</div>
<script>
const AV_KEY='avatarSimple1';
function loadAvatar(){ try{ return JSON.parse(localStorage.getItem(AV_KEY))||{hair:'gray',glasses:true}; }catch(e){ return {hair:'gray',glasses:true}; } }
function saveAvatar(v){ localStorage.setItem(AV_KEY, JSON.stringify(v)); }
let AV_OPT=loadAvatar();

const c=document.getElementById('c'), ctx=c.getContext('2d');
let w=innerWidth, h=innerHeight; c.width=w; c.height=h;
addEventListener('resize', ()=>{ w=innerWidth; h=innerHeight; c.width=w; c.height=h; });

let x=w/2, y=h/2, r=16, vx=0, vy=0;

function drawAvatar(ctx,x,y,opt){
  ctx.fillStyle='#f2c7a5'; ctx.beginPath(); ctx.arc(x,y-18,12,0,Math.PI*2); ctx.fill(); // face
  const hair=opt.hair==='black'?'#374151':opt.hair==='brown'?'#8b5e34':'#9ca3af';
  ctx.fillStyle=hair; ctx.fillRect(x-12,y-28,24,8); ctx.beginPath(); ctx.arc(x,y-24,12,Math.PI,0); ctx.fill();
  if(opt.glasses){ ctx.strokeStyle='#cbd5e1'; ctx.lineWidth=2; ctx.strokeRect(x-10,y-22,10,8); ctx.strokeRect(x+0,y-22,10,8); }
  ctx.fillStyle='#22d3ee'; ctx.fillRect(x-12,y-6,24,24); // body
  ctx.fillStyle='#a3a3a3'; ctx.fillRect(x-10,y+18,8,4); ctx.fillRect(x+2,y+18,8,4); // shoes
}

const keys={}; addEventListener('keydown',e=>keys[e.key]=true); addEventListener('keyup',e=>keys[e.key]=false);

function loop(){
  vx=(keys.ArrowRight?160:0)-(keys.ArrowLeft?160:0);
  vy=(keys.ArrowDown?160:0)-(keys.ArrowUp?160:0);
  x=Math.max(r,Math.min(w-r,x+vx/60));
  y=Math.max(r,Math.min(h-r,y+vy/60));

  ctx.fillStyle='#0a0f25'; ctx.fillRect(0,0,w,h);
  drawAvatar(ctx,x,y,AV_OPT);
  ctx.fillStyle='#fff'; ctx.font='14px sans-serif'; ctx.fillText('←↑→↓で移動 / 右上でアバター切替',10,20);
  requestAnimationFrame(loop);
}
loop();

document.getElementById('avatarBtn').onclick=()=>{
  const presets=[{hair:'gray',glasses:true},{hair:'black',glasses:false},{hair:'brown',glasses:true}];
  let i=Number(localStorage.getItem(AV_KEY+'_i')||0); i=(i+1)%presets.length;
  AV_OPT=presets[i]; saveAvatar(AV_OPT); localStorage.setItem(AV_KEY+'_i',i);
  alert('アバターを切り替えました（'+(i+1)+'/'+presets.length+'）');
};

// PWA
if('serviceWorker' in navigator){ navigator.serviceWorker.register('./sw.js'); }
</script>
<link rel="manifest" href="manifest.webmanifest">
